name: AI Daily News Generator

on:
  # æ¯å¤© UTC 23:00 æ‰§è¡Œ = åŒ—äº¬æ—¶é—´æ¬¡æ—¥ 07:00
  schedule:
    - cron: '0 23 * * *'

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘ï¼ˆå¯é€‰ï¼Œç”¨äºæµ‹è¯•ï¼‰
  push:
    branches:
      - main
    paths:
      - '.github/workflows/daily.yml'
      - 'src/**'
      - 'requirements.txt'

# é˜²æ­¢å¹¶å‘æ‰§è¡Œ
concurrency:
  group: ai-daily
  cancel-in-progress: false

# æƒé™é…ç½®
permissions:
  contents: write

jobs:
  build:
    name: ç”Ÿæˆ AI èµ„è®¯æ—¥æŠ¥
    runs-on: ubuntu-latest

    # è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆ30åˆ†é’Ÿï¼‰
    timeout-minutes: 30

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        run: |
          echo "Python ç‰ˆæœ¬: $(python --version)"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "å½“å‰æ—¶é—´ (UTC): $(date -u)"
          echo "ç›®æ ‡æ—¥æœŸ (å‰ä¸¤å¤©): $(date -u -d '2 days ago' +%Y-%m-%d)"

      - name: è¿è¡Œ AI Daily ç”Ÿæˆå™¨
        env:
          # Claude API é…ç½®ï¼ˆä½¿ç”¨æ™ºè°±ä»£ç†ï¼‰
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL || 'https://open.bigmodel.cn/api/anthropic' }}

          # é‚®ä»¶é€šçŸ¥é…ç½®
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          NOTIFICATION_TO: ${{ secrets.NOTIFICATION_TO }}

          # å›¾ç‰‡ç”Ÿæˆ API é…ç½®ï¼ˆFirefly Card APIï¼‰
          ENABLE_IMAGE_GENERATION: ${{ secrets.ENABLE_IMAGE_GENERATION || 'true' }}
          FIREFLY_API_URL: ${{ secrets.FIREFLY_API_URL || 'https://fireflycard-api.302ai.cn/api/saveImg' }}
          FIREFLY_API_KEY: ${{ secrets.FIREFLY_API_KEY }}

          # é’‰é’‰æœºå™¨äººé…ç½®
          ENABLE_DINGTALK: ${{ secrets.ENABLE_DINGTALK || 'false' }}
          DINGTALK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK_URL }}
          DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}

          # GitHub Pages URLï¼ˆç”¨äºé’‰é’‰/é‚®ä»¶ä¸­çš„é“¾æ¥ï¼‰
          GITHUB_PAGES_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}

          # GitHub ç¯å¢ƒå˜é‡ï¼ˆç”¨äºæ—¥å¿—é“¾æ¥ï¼‰
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
        run: |
          python src/main.py

      - name: æ£€æŸ¥ç”Ÿæˆç»“æœ
        run: |
          if [ ! -d "docs" ]; then
            echo "âŒ é”™è¯¯: docs ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          if [ ! -f "docs/index.html" ]; then
            echo "âŒ é”™è¯¯: index.html æœªç”Ÿæˆ"
            exit 1
          fi
          echo "âœ… æ–‡ä»¶æ£€æŸ¥é€šè¿‡"
          ls -lh docs/

      - name: éƒ¨ç½²åˆ° GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          keep_files: true
          commit_message: 'ğŸ¤– Auto update AI Daily - {{ date }}'
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆç”¨äºè°ƒè¯•ï¼‰
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-daily-output
          path: docs/
          retention-days: 7
